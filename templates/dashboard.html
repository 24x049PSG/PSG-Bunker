<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - PSG Bunker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
</head>
<body>
    <div class="container">
        <h1>ðŸ“š PSG Bunker Dashboard</h1>

        <div class="alert alert-success">
            Welcome, {{ rollno }} | PSG College of Technology
        </div>

        <div id="attendance">
            <h2>ðŸ“š Subject-wise Attendance</h2>

            <div id="attendance-grid" class="grid">
                <!-- Attendance cards will be populated by JavaScript -->
            </div>
        </div>

        <div id="cgpa-section">
            <h2>ðŸŽ“ Academic Performance</h2>

            <div class="grid grid-3">
                <div class="stat-card">
                    <span class="stat-number" id="cgpa-value">{{ cgpa.total_cgpa or '0.0' }}</span>
                    <span class="stat-label">Total CGPA</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="latest-sem">{{ cgpa.latest_sem or '-' }}</span>
                    <span class="stat-label">Latest Semester</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="total-sems">{{ cgpa.total_semesters or '0' }}</span>
                    <span class="stat-label">Semesters Completed</span>
                </div>
            </div>
        </div>

        <div class="share-section text-center mt-3">
            <button onclick="shareWebsite()" class="share-btn">
                ðŸ”— Share PSG Bunker
            </button>
        </div>

        <footer>
            <p>Manu Sanjay BTech IT PSG TECH</p>
            <p>Â© 2025 PSG College of Technology</p>
        </footer>
    </div>

    <script>
        // Function to share the website
        function shareWebsite() {
            const url = 'https://psgbunker.in.net';
            const title = 'PSG Bunker - Attendance & CGPA Tracker';
            const text = 'Check out PSG Bunker for tracking your attendance and CGPA at PSG Tech!';

            if (navigator.share) {
                navigator.share({
                    title: title,
                    text: text,
                    url: url
                }).catch(console.error);
            } else {
                // Fallback for browsers that don't support Web Share API
                const shareText = `${title}\n${text}\n${url}`;
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(shareText).then(() => {
                        alert('Website link copied to clipboard!');
                    });
                } else {
                    // Final fallback
                    const textArea = document.createElement('textarea');
                    textArea.value = shareText;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('Website link copied to clipboard!');
                }
            }
        }

        async function loadAttendance() {
            try {
                const response = await fetch('/attendance');
                const data = await response.json();

                if (data.error) {
                    document.getElementById('attendance-grid').innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                    return;
                }

                const grid = document.getElementById('attendance-grid');
                grid.innerHTML = '';

                // Create subject cards with course titles
                data.subjects.forEach(subject => {
                    const card = document.createElement('div');

                    // Determine card style based on attendance
                    const percentage = subject.percentage_of_attendance;
                    let cardClass = 'subject-card ';
                    let percentageClass = '';
                    let statusClass = '';

                    if (percentage >= 85) {
                        cardClass += 'success';
                        percentageClass = 'success';
                        statusClass = 'status-can-miss';
                    } else if (percentage >= 75) {
                        cardClass += 'warning';
                        percentageClass = 'warning';
                        statusClass = 'status-can-miss';
                    } else {
                        cardClass += 'danger';
                        percentageClass = 'danger';
                        statusClass = 'status-must-attend';
                    }

                    // Card with course title prominently displayed
                    card.className = cardClass;
                    card.innerHTML = `
                        <div class="subject-title">
                            ${subject.course_title || subject.name}
                        </div>

                        <div class="subject-main-info">
                            <div class="attendance-percentage">
                                <span class="percentage-number ${percentageClass}">${percentage.toFixed(1)}%</span>
                                <div class="attendance-details">
                                    ${subject.total_present}/${subject.total_hours} classes attended
                                </div>
                            </div>

                            <div class="status-display">
                                ${subject.status === 'can_bunk' ? 
                                    `<span class="status-number ${statusClass}">${subject.classes_to_bunk}</span>
                                     <div class="status-label ${statusClass}">Can Miss</div>` :
                                    `<span class="status-number ${statusClass}">${subject.classes_to_attend}</span>
                                     <div class="status-label ${statusClass}">Must Attend</div>`
                                }
                            </div>
                        </div>

                        <div class="subject-footer">
                            <div class="course-code">Course Code: ${subject.course_code || subject.original_name}</div>
                            <div class="subject-type">Type: ${subject.type}</div>
                            <div>Period: ${subject.attendance_from} to ${subject.attendance_to}</div>
                        </div>
                    `;

                    grid.appendChild(card);
                });

            } catch (error) {
                console.error('Error loading attendance:', error);
                document.getElementById('attendance-grid').innerHTML = '<div class="alert alert-danger">Error loading attendance data</div>';
            }
        }

        async function loadCGPA() {
            try {
                const response = await fetch('/cgpa');
                const data = await response.json();

                if (!data.error) {
                    document.getElementById('cgpa-value').textContent = data.total_cgpa || '0.0';
                    document.getElementById('latest-sem').textContent = data.latest_sem || '-';
                    document.getElementById('total-sems').textContent = data.total_semesters || '0';
                }
            } catch (error) {
                console.error('Error loading CGPA:', error);
            }
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadAttendance();
            loadCGPA();
        });
    </script>
</body>
</html>
